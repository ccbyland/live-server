name: 部署前端到 GitHub Pages

on:
  push:
    branches: [master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: 安装 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "21"

      - name: 安装依赖
        run: yarn

      - name: 构建项目
        run: yarn build

      - name: 查看 out 目录
        run: ls -la out

      - name: 打印部署地址
        run: |
          echo "部署地址： https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

      - name: 发布到 GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out

      - name: 打印 AWS 凭证（测试用）
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}"
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          echo "AWS_REGION=${{ secrets.AWS_REGION }}"

      - name: 配置AWS凭证
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: 上传到 S3
        run: aws s3 sync ./out ${{ vars.AWS_BUCKET_NAME }}
