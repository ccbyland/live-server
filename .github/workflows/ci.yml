name: éƒ¨ç½²å‰ç«¯åˆ° GitHub Pages å’Œ S3

# ğŸ§¨ æ‰‹åŠ¨è§¦å‘ï¼Œå…è®¸é€‰æ‹©æ„å»ºç¯å¢ƒå’Œç‰ˆæœ¬å·
on:
  workflow_dispatch:
    inputs:
      build_env:
        description: "æ„å»ºç¯å¢ƒï¼ˆå¦‚ prod / testï¼‰"
        required: true
        default: "prod"
      version:
        description: "ç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.0ï¼‰"
        required: true
        default: "v1.0.0"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      BUILD_ENV: ${{ github.event.inputs.build_env }}
      VERSION: ${{ github.event.inputs.version }}

    steps:
      # ğŸ§© åˆå§‹åŒ–é˜¶æ®µ -------------------------
      - name: âœ… æ‹‰å–ä»£ç 
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: ğŸŸ¦ å®‰è£… Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "21"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: yarn install --frozen-lockfile

      # ğŸ—ï¸ æ„å»ºé˜¶æ®µ -------------------------
      - name: ğŸ› ï¸ æ„å»ºé¡¹ç›®
        run: |
          echo "ğŸš§ æ„å»ºç¯å¢ƒï¼š$BUILD_ENV"
          echo "ğŸš€ æ„å»ºç‰ˆæœ¬ï¼š$VERSION"

          case "$BUILD_ENV" in
            test)
              yarn build:test
              ;;
            prod)
              yarn build:prod
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æ„å»ºç¯å¢ƒï¼š$BUILD_ENVï¼ˆè¯·ä½¿ç”¨ prod æˆ– testï¼‰"
              exit 1
              ;;
          esac

      - name: ğŸ” æŸ¥çœ‹æ„å»ºäº§ç‰©
        run: ls -la out

      - name: ğŸ“¢ æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "âœ… æ„å»ºå®Œæˆ"
          echo "ğŸ“¤ S3 ç›®æ ‡è·¯å¾„: s3://${{ secrets.AWS_BUCKET_NAME }}/$VERSION"

      # ğŸš€ å‘å¸ƒé˜¶æ®µ -------------------------
      - name: ğŸš€ å‘å¸ƒåˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out

      - name: ğŸ” é…ç½® AWS å‡­è¯
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸ“¤ ä¸Šä¼ åˆ° S3ï¼ˆæŒ‰ç‰ˆæœ¬ç›®å½•ï¼‰
        run: |
          echo "ğŸ”„ æ­£åœ¨ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° S3..."
          aws s3 sync ./out s3://${{ secrets.AWS_BUCKET_NAME }}/$VERSION --delete
          echo "âœ… ä¸Šä¼ æˆåŠŸï¼šs3://${{ secrets.AWS_BUCKET_NAME }}/$VERSION"
